---
layout: post

title: "测试金字塔"
date: 2020-08-13
categories: [Agile]
tags: [AGILE-TEST]
column: AGILE-Test
sub-tag: "common"

author: "袁慎建"

brief: "
当你在思考如何使用不同类型的自动化测试来创建一个平衡的测试组合的时候，测试金字塔能为你提供一个很好的参考。它的核心观点是：底层单元测试应多于基于GUI的高层端到端测试。
"

---

* content
{:toc}



当你在思考如何使用不同类型的自动化测试来创建一个平衡的测试组合的时候，测试金字塔能为你提供一个很好的参考。它的核心观点是：底层单元测试应多于基于GUI的高层端到端测试。


![]({{ site.url | append: '/assets/images/column/agile-test/test-pyramid.png'}})


在我职业生涯的大部分时间中，测试自动化意味着要使用自动化测试工具在用户界面上操控应用程序。这些工具通常可以录制和回放交互过程，并能验证应用程序是否返回了同样的结果。起初这种方式工作得很好。测试很容易录制，就连没有编程经验的人也能轻松搞定。

但是，这种方法很快就陷入了困境，演变成所谓的 [蛋卷冰淇淋](https://alisterbscott.com/kb/testing-pyramids/)。原因有很多，这里我列出主要的几条。首先，基于UI的测试运行很慢，增加了构建时间。其次，它经常需安装测试自动化软件许可证，这就意味着只能在特定的机器上运行；另外，这些测试往往无法轻易地以“headless”[译注1]模式运行，即不能通过脚本进行UI监视，从而将其集成到合适的部署流水线上。


最重要的一条原因是，这些测试太脆弱了。对系统功能的增强很容易破坏大量的测试，导致我们不得不重新录制。当然，你可以放弃这些工具来减少此类问题的发生，但这样又增加了测试的编写难度[注1]。 即使你采用了一些优秀的实践，端到端测试也相对更容易出现[不确定性问题](https://martinfowler.com/articles/nonDeterminism.html)，这会破坏测试可靠性。 简而言之，基于UI的端到端测试存在这些缺点：脆弱、编写成本高且运行缓慢。 因此，测试金字塔提倡 -- 相比于传统基于GUI的测试，你应该编写更多的自动化通元测试[注2]。



测试金字塔还提倡引入面向应用程序服务层的中间层测试，我称之为皮下测试（[SubdermaTests](https://martinfowler.com/bliki/SubcutaneousTest.html)）。 这些测试既保持了端到端测试的诸多优势，又避免了处理UI框架的诸多复杂性。在Web应用程序中，皮下测试相当于API层的测试，位于金字塔的顶部UI测试相当于那些使用了[Selenium](https://www.selenium.dev/)或Sahi相关工具的测试。


测试金字塔引申出敏捷测试生命周期的诸多核心概念，它更提倡建立一个合理的测试组合。现实中的一个常见的问题是，一些团队会将端到端测试、单元测试和面向客户的测试混为一谈，但它们其实是独立正交的。例如，对于富javascript的用户界面来说，你应该使用[Jasmine](https://jasmine.github.io/)之类的工具对其绝大多数UI行为进行单元测试；而对于复杂的业务规则集合，则可以通过面向客户的表单进行测试，并且应该跟单元测试一样只涉及相关的模块。


我始终认为高层测试是测试防护体系的第二道防线。如果一个高层测试失败了，不仅表明功能代码存在错误，还意味着缺乏一个正确的单元测试。因此，我建议在修复由高层测试暴露的错误之前，你应该使用单元测试来复现该错误，从而利用单元测试来确保错误已被修复。


#### 注释
1. 注1: 对任何类型的自动化来说，录制-回放工具几乎都是个糟糕的主意。因为它们会降低易变性并且阻碍我们进行有用的抽象。它们仅值得作为生成脚本片段的工具，以便你在随后使用合适的编程语言进行改写，就像[Twist](https://www.thoughtworks.com/what-we-do/products)和[Emacs](http://www.gnu.org/software/emacs/manual/html_node/emacs/Save-Keyboard-Macro.html)那样。

2. 注2：金字塔是基于这样的假设，与单元测试这种低层级、细粒度测试相比，高层级、粗粒度测试的成本高、速度慢且脆弱。 尽管通常是这样，但也有例外。 如果你的高层级测试运行快、可靠且修改成本低，你就不需要较低层级的测试。

3. 译注1：Headless模式，指的是以 *无可见UI的模式运行浏览器UI测试*，即可以通过脚本在测试过程中正常执行UI相关的功能，但不需要启动一个可见的UI。通常在持续集成流水线中使用，因为是脚本驱动，没有人观看UI效果，这样就可以节省浏览器GUI的额外开销。


#### 词源
大多数人了解到测试金字塔是源于迈克·科恩（Mike Cohn）在他的2009年《[Scrum敏捷软件开发](https://book.douban.com/subject/5334585/)》中的描述。 他在书中将其称为“测试自动化金字塔”，但在使用中通常仅称为“测试金字塔”。测试金字塔最初是他在2003年4月与Lisa Crispin对话时绘制的，并在2004年的一次Scrum聚会上对其进行了描述。JasonHuggins在2006年左右也提出了相同的观点。


#### 声明
本文翻译自Martin Fowler的文章TestPyramid：

- 原文链接： [TestPyramid](https://martinfowler.com/bliki/TestPyramid.html)
- 原文作者： [Martin Fowler](https://martinfowler.com/)
