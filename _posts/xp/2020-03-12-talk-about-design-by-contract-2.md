---
layout: "post"
title: "简单聊聊契约设计（下）"
date: 2020-03-12
categories: [eXtreme Programming]
tag: [eXtreme Programming, DBC]

author: "袁慎建"

---

* content
{:toc}

---

聊了这么多，说起来我们好像是在基于用户的合理假设来审视我们的模型设计，而这种用户的合理假设可能会让人觉得心里不踏实，如何才能知道客户的真正要求呢？Bob大叔提到了一项技术，也就是我们要聊的主题DBC (Design By Contract)，能够帮助明确用户的合理的假设。

当然这个技术不是他原创的，下一篇文章我会来聊聊DBC到底是个什么东西？


![]({{site.image_path_post}}{{page.url}}{{'dbc.png'}})


## 买房子的契约
派生类的前置条件和后置条件满足一下规则：

1. 只能使用相等或更弱的前置条件
2. 只能使用相等或更强的后置条件

用户通过基类使用独对象时，用户只知道基类的前置条件和后置条件，因此派生类不能要求客户遵循比基类更强的前置条件，他们必须接受基类可接受的一切，派生类必须和基类的后置条件一致，也就是说，派生类的行为方式和输出不能违反基类已经确立的任何限制，基类的用户不应该被派生类的输出扰乱。



`Rectangle.setWidth(double width)`：

- 前置条件是：`type width is double`
- 后置条件是：`this.width == width && this.height = old.height`


`Square.setWidth(double width)`：

- 前置条件是：`type width is double`
- 后置条件是：`this.width == width && this.height = width`


派生类的前置条件没有比之前更严格，但后置条件破坏了原有的限制。这种设计就破坏契约了。


这就好比你在买房，房产销售顾问小吴跟你签了个协议，协议里对你的约定：

1. 3.15号之前缴纳剩余100万首付款
2. 支付宝、储蓄卡或者现金

合同里对房产商的约定：

1. 3.15号之前房源被锁定，不再对外销售：
2. 提供24小时私人订制服务。

后来小吴因为有事情休假了，让小高代替服务你，这时候如果他要求做了以下几件事情：

1. 要求你3.13要缴纳剩余100首付款。
2. 只能付现金或刷储蓄卡。

3. 3.13号将房源对外公布购买。
4. 下午8 ~ 10点打电话关机。

如果小吴看成父类，小高看成子类，提供服务相当于小吴提供的方法，小高继承了小吴后：

- 方法的前置条件更加严格了：1，2相当于协议的前置条件更强了；
- 方法后置条件被破坏了：3，4相当于协议的后置条件被破坏了

用户如果以跟小吴合作的方式，上述的事情发生后，用户这边肯定遭遇很多意想不到的意外结果，这时候作为用户的你，肯定会不乐意了。






